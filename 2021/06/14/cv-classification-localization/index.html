<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文在MNIST数据集上实现数字的Classification和Localization。">
<meta property="og:type" content="article">
<meta property="og:title" content="Image Classification and Object Localization">
<meta property="og:url" content="http://example.com/2021/06/14/cv-classification-localization/index.html">
<meta property="og:site_name" content="半杯茶的小酒杯">
<meta property="og:description" content="本文在MNIST数据集上实现数字的Classification和Localization。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/06/14/cv-classification-localization/training_label.png">
<meta property="og:image" content="http://example.com/2021/06/14/cv-classification-localization/validation_label.png">
<meta property="og:image" content="http://example.com/2021/06/14/cv-classification-localization/classification_box_loss.png">
<meta property="og:image" content="http://example.com/visualize_prediction.png">
<meta property="article:published_time" content="2021-06-14T01:55:38.000Z">
<meta property="article:modified_time" content="2021-06-17T15:26:55.751Z">
<meta property="article:author" content="Young Times">
<meta property="article:tag" content="自动驾驶">
<meta property="article:tag" content="机器学习">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/06/14/cv-classification-localization/training_label.png">

<link rel="canonical" href="http://example.com/2021/06/14/cv-classification-localization/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Image Classification and Object Localization | 半杯茶的小酒杯</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">半杯茶的小酒杯</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/14/cv-classification-localization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="Young Times">
      <meta itemprop="description" content="路要一步一步的走">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="半杯茶的小酒杯">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Image Classification and Object Localization
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-14 09:55:38" itemprop="dateCreated datePublished" datetime="2021-06-14T09:55:38+08:00">2021-06-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 23:26:55" itemprop="dateModified" datetime="2021-06-17T23:26:55+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/" itemprop="url" rel="index"><span itemprop="name">自动驾驶</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/06/14/cv-classification-localization/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/14/cv-classification-localization/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文在MNIST数据集上实现数字的Classification和Localization。</p>
<span id="more"></span>

<h1 id="Imports"><a href="#Imports" class="headerlink" title="Imports"></a>Imports</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, re, time, json</span><br><span class="line"><span class="keyword">import</span> PIL.Image, PIL.ImageFont, PIL.ImageDraw</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  <span class="comment"># %tensorflow_version only exists in Colab.</span></span><br><span class="line">  %tensorflow_version <span class="number">2.</span>x</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Tensorflow version &quot;</span> + tf.__version__)</span><br></pre></td></tr></table></figure>

<h1 id="Visualization-Utilities"><a href="#Visualization-Utilities" class="headerlink" title="Visualization Utilities"></a>Visualization Utilities</h1><p>工具函数类，实现在图像上绘制Bounding Box。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">im_width = <span class="number">75</span></span><br><span class="line">im_height = <span class="number">75</span></span><br><span class="line">use_normalized_coordinates = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_bounding_boxes_on_image_array</span>(<span class="params">image,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       boxes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       color=[],</span></span></span><br><span class="line"><span class="function"><span class="params">                                       thickness=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       display_str_list=(<span class="params"></span>)</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;Draws bounding boxes on image (numpy array).</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    image: a numpy array object.</span></span><br><span class="line"><span class="string">    boxes: a 2 dimensional numpy array of [N, 4]: (ymin, xmin, ymax, xmax).</span></span><br><span class="line"><span class="string">           The coordinates are in normalized format between [0, 1].</span></span><br><span class="line"><span class="string">    color: color to draw bounding box. Default is red.</span></span><br><span class="line"><span class="string">    thickness: line thickness. Default value is 4.</span></span><br><span class="line"><span class="string">    display_str_list_list: a list of strings for each bounding box.</span></span><br><span class="line"><span class="string">  Raises:</span></span><br><span class="line"><span class="string">    ValueError: if boxes is not a [N, 4] array</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  image_pil = PIL.Image.fromarray(image)</span><br><span class="line">  rgbimg = PIL.Image.new(<span class="string">&quot;RGBA&quot;</span>, image_pil.size)</span><br><span class="line">  rgbimg.paste(image_pil)</span><br><span class="line">  draw_bounding_boxes_on_image(rgbimg, boxes, color, thickness,</span><br><span class="line">                               display_str_list)</span><br><span class="line">  <span class="keyword">return</span> np.array(rgbimg)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_bounding_boxes_on_image</span>(<span class="params">image,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 boxes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 color=[],</span></span></span><br><span class="line"><span class="function"><span class="params">                                 thickness=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 display_str_list=(<span class="params"></span>)</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;Draws bounding boxes on image.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    image: a PIL.Image object.</span></span><br><span class="line"><span class="string">    boxes: a 2 dimensional numpy array of [N, 4]: (ymin, xmin, ymax, xmax).</span></span><br><span class="line"><span class="string">           The coordinates are in normalized format between [0, 1].</span></span><br><span class="line"><span class="string">    color: color to draw bounding box. Default is red.</span></span><br><span class="line"><span class="string">    thickness: line thickness. Default value is 4.</span></span><br><span class="line"><span class="string">    display_str_list: a list of strings for each bounding box.</span></span><br><span class="line"><span class="string">                           </span></span><br><span class="line"><span class="string">  Raises:</span></span><br><span class="line"><span class="string">    ValueError: if boxes is not a [N, 4] array</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  boxes_shape = boxes.shape</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> boxes_shape:</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(boxes_shape) != <span class="number">2</span> <span class="keyword">or</span> boxes_shape[<span class="number">1</span>] != <span class="number">4</span>:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Input must be of size [N, 4]&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(boxes_shape[<span class="number">0</span>]):</span><br><span class="line">    draw_bounding_box_on_image(image, boxes[i, <span class="number">1</span>], boxes[i, <span class="number">0</span>], boxes[i, <span class="number">3</span>],</span><br><span class="line">                               boxes[i, <span class="number">2</span>], color[i], thickness, display_str_list[i])</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_bounding_box_on_image</span>(<span class="params">image,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ymin,</span></span></span><br><span class="line"><span class="function"><span class="params">                               xmin,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ymax,</span></span></span><br><span class="line"><span class="function"><span class="params">                               xmax,</span></span></span><br><span class="line"><span class="function"><span class="params">                               color=<span class="string">&#x27;red&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                               thickness=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                               display_str=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                               use_normalized_coordinates=<span class="literal">True</span></span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;Adds a bounding box to an image.</span></span><br><span class="line"><span class="string">  Bounding box coordinates can be specified in either absolute (pixel) or</span></span><br><span class="line"><span class="string">  normalized coordinates by setting the use_normalized_coordinates argument.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    image: a PIL.Image object.</span></span><br><span class="line"><span class="string">    ymin: ymin of bounding box.</span></span><br><span class="line"><span class="string">    xmin: xmin of bounding box.</span></span><br><span class="line"><span class="string">    ymax: ymax of bounding box.</span></span><br><span class="line"><span class="string">    xmax: xmax of bounding box.</span></span><br><span class="line"><span class="string">    color: color to draw bounding box. Default is red.</span></span><br><span class="line"><span class="string">    thickness: line thickness. Default value is 4.</span></span><br><span class="line"><span class="string">    display_str_list: string to display in box</span></span><br><span class="line"><span class="string">    use_normalized_coordinates: If True (default), treat coordinates</span></span><br><span class="line"><span class="string">      ymin, xmin, ymax, xmax as relative to the image.  Otherwise treat</span></span><br><span class="line"><span class="string">      coordinates as absolute.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  draw = PIL.ImageDraw.Draw(image)</span><br><span class="line">  im_width, im_height = image.size</span><br><span class="line">  <span class="keyword">if</span> use_normalized_coordinates:</span><br><span class="line">    (left, right, top, bottom) = (xmin * im_width, xmax * im_width,</span><br><span class="line">                                  ymin * im_height, ymax * im_height)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    (left, right, top, bottom) = (xmin, xmax, ymin, ymax)</span><br><span class="line">  draw.line([(left, top), (left, bottom), (right, bottom),</span><br><span class="line">             (right, top), (left, top)], width=thickness, fill=color)</span><br></pre></td></tr></table></figure>

<p>下面的函数用于可视化训练和预测数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#@title Visualization Utilities [RUN ME]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">This cell contains helper functions used for visualization</span></span><br><span class="line"><span class="string">and downloads only. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can skip reading it, as there is very</span></span><br><span class="line"><span class="string">little Keras or Tensorflow related code here.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Matplotlib config</span></span><br><span class="line">plt.rc(<span class="string">&#x27;image&#x27;</span>, cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;grid&#x27;</span>, linewidth=<span class="number">0</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;xtick&#x27;</span>, top=<span class="literal">False</span>, bottom=<span class="literal">False</span>, labelsize=<span class="string">&#x27;large&#x27;</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;ytick&#x27;</span>, left=<span class="literal">False</span>, right=<span class="literal">False</span>, labelsize=<span class="string">&#x27;large&#x27;</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;axes&#x27;</span>, facecolor=<span class="string">&#x27;F8F8F8&#x27;</span>, titlesize=<span class="string">&quot;large&quot;</span>, edgecolor=<span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;text&#x27;</span>, color=<span class="string">&#x27;a8151a&#x27;</span>)</span><br><span class="line">plt.rc(<span class="string">&#x27;figure&#x27;</span>, facecolor=<span class="string">&#x27;F0F0F0&#x27;</span>)<span class="comment"># Matplotlib fonts</span></span><br><span class="line">MATPLOTLIB_FONT_DIR = os.path.join(os.path.dirname(plt.__file__), <span class="string">&quot;mpl-data/fonts/ttf&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pull a batch from the datasets. This code is not very nice, it gets much better in eager mode (TODO)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dataset_to_numpy_util</span>(<span class="params">training_dataset, validation_dataset, N</span>):</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># get one batch from each: 10000 validation digits, N training digits</span></span><br><span class="line">  batch_train_ds = training_dataset.unbatch().batch(N)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># eager execution: loop through datasets normally</span></span><br><span class="line">  <span class="keyword">if</span> tf.executing_eagerly():</span><br><span class="line">    <span class="keyword">for</span> validation_digits, (validation_labels, validation_bboxes) <span class="keyword">in</span> validation_dataset:</span><br><span class="line">      validation_digits = validation_digits.numpy()</span><br><span class="line">      validation_labels = validation_labels.numpy()</span><br><span class="line">      validation_bboxes = validation_bboxes.numpy()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> training_digits, (training_labels, training_bboxes) <span class="keyword">in</span> batch_train_ds:</span><br><span class="line">      training_digits = training_digits.numpy()</span><br><span class="line">      training_labels = training_labels.numpy()</span><br><span class="line">      training_bboxes = training_bboxes.numpy()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># these were one-hot encoded in the dataset</span></span><br><span class="line">  validation_labels = np.argmax(validation_labels, axis=<span class="number">1</span>)</span><br><span class="line">  training_labels = np.argmax(training_labels, axis=<span class="number">1</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (training_digits, training_labels, training_bboxes,</span><br><span class="line">          validation_digits, validation_labels, validation_bboxes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create digits from local fonts for testing</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_digits_from_local_fonts</span>(<span class="params">n</span>):</span></span><br><span class="line">  font_labels = []</span><br><span class="line">  img = PIL.Image.new(<span class="string">&#x27;LA&#x27;</span>, (<span class="number">75</span>*n, <span class="number">75</span>), color = (<span class="number">0</span>,<span class="number">255</span>)) <span class="comment"># format &#x27;LA&#x27;: black in channel 0, alpha in channel 1</span></span><br><span class="line">  font1 = PIL.ImageFont.truetype(os.path.join(MATPLOTLIB_FONT_DIR, <span class="string">&#x27;DejaVuSansMono-Oblique.ttf&#x27;</span>), <span class="number">25</span>)</span><br><span class="line">  font2 = PIL.ImageFont.truetype(os.path.join(MATPLOTLIB_FONT_DIR, <span class="string">&#x27;STIXGeneral.ttf&#x27;</span>), <span class="number">25</span>)</span><br><span class="line">  d = PIL.ImageDraw.Draw(img)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    font_labels.append(i%<span class="number">10</span>)</span><br><span class="line">    d.text((<span class="number">7</span>+i*<span class="number">75</span>,<span class="number">0</span> <span class="keyword">if</span> i&lt;<span class="number">10</span> <span class="keyword">else</span> -<span class="number">4</span>), <span class="built_in">str</span>(i%<span class="number">10</span>), fill=(<span class="number">255</span>,<span class="number">255</span>), font=font1 <span class="keyword">if</span> i&lt;<span class="number">10</span> <span class="keyword">else</span> font2)</span><br><span class="line">  font_digits = np.array(img.getdata(), np.float32)[:,<span class="number">0</span>] / <span class="number">255.0</span> <span class="comment"># black in channel 0, alpha in channel 1 (discarded)</span></span><br><span class="line">  font_digits = np.reshape(np.stack(np.split(np.reshape(font_digits, [<span class="number">75</span>, <span class="number">75</span>*n]), n, axis=<span class="number">1</span>), axis=<span class="number">0</span>), [n, <span class="number">75</span>*<span class="number">75</span>])</span><br><span class="line">  <span class="keyword">return</span> font_digits, font_labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># utility to display a row of digits with their predictions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_digits_with_boxes</span>(<span class="params">digits, predictions, labels, pred_bboxes, bboxes, iou, title</span>):</span></span><br><span class="line"></span><br><span class="line">  n = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  indexes = np.random.choice(<span class="built_in">len</span>(predictions), size=n)</span><br><span class="line">  n_digits = digits[indexes]</span><br><span class="line">  n_predictions = predictions[indexes]</span><br><span class="line">  n_labels = labels[indexes]</span><br><span class="line"></span><br><span class="line">  n_iou = []</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(iou) &gt; <span class="number">0</span>:</span><br><span class="line">    n_iou = iou[indexes]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">len</span>(pred_bboxes) &gt; <span class="number">0</span>):</span><br><span class="line">    n_pred_bboxes = pred_bboxes[indexes,:]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">len</span>(bboxes) &gt; <span class="number">0</span>):</span><br><span class="line">    n_bboxes = bboxes[indexes,:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  n_digits = n_digits * <span class="number">255.0</span></span><br><span class="line">  n_digits = n_digits.reshape(n, <span class="number">75</span>, <span class="number">75</span>)</span><br><span class="line">  fig = plt.figure(figsize=(<span class="number">20</span>, <span class="number">4</span>))</span><br><span class="line">  plt.title(title)</span><br><span class="line">  plt.yticks([])</span><br><span class="line">  plt.xticks([])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    ax = fig.add_subplot(<span class="number">1</span>, <span class="number">10</span>, i+<span class="number">1</span>)</span><br><span class="line">    bboxes_to_plot = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(pred_bboxes) &gt; i):</span><br><span class="line">      bboxes_to_plot.append(n_pred_bboxes[i])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(bboxes) &gt; i):</span><br><span class="line">      bboxes_to_plot.append(n_bboxes[i])</span><br><span class="line"></span><br><span class="line">    img_to_draw = draw_bounding_boxes_on_image_array(image=n_digits[i], boxes=np.asarray(bboxes_to_plot), color=[<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;green&#x27;</span>], display_str_list=[<span class="string">&quot;true&quot;</span>, <span class="string">&quot;pred&quot;</span>])</span><br><span class="line">    plt.xlabel(n_predictions[i])</span><br><span class="line">    plt.xticks([])</span><br><span class="line">    plt.yticks([])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> n_predictions[i] != n_labels[i]:</span><br><span class="line">      ax.xaxis.label.set_color(<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    plt.imshow(img_to_draw)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(iou) &gt; i :</span><br><span class="line">      color = <span class="string">&quot;black&quot;</span></span><br><span class="line">      <span class="keyword">if</span> (n_iou[i][<span class="number">0</span>] &lt; iou_threshold):</span><br><span class="line">        color = <span class="string">&quot;red&quot;</span></span><br><span class="line">      ax.text(<span class="number">0.2</span>, -<span class="number">0.3</span>, <span class="string">&quot;iou: %s&quot;</span> %(n_iou[i][<span class="number">0</span>]), color=color, transform=ax.transAxes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># utility to display training and validation curves</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_metrics</span>(<span class="params">metric_name, title, ylim=<span class="number">5</span></span>):</span></span><br><span class="line">  plt.title(title)</span><br><span class="line">  plt.ylim(<span class="number">0</span>,ylim)</span><br><span class="line">  plt.plot(history.history[metric_name],color=<span class="string">&#x27;blue&#x27;</span>,label=metric_name)</span><br><span class="line">  plt.plot(history.history[<span class="string">&#x27;val_&#x27;</span> + metric_name],color=<span class="string">&#x27;green&#x27;</span>,label=<span class="string">&#x27;val_&#x27;</span> + metric_name)</span><br></pre></td></tr></table></figure>

<h1 id="TPU-or-GPU-detection"><a href="#TPU-or-GPU-detection" class="headerlink" title="TPU or GPU detection"></a>TPU or GPU detection</h1><p>根据不同的硬件，选择不同的分布式策略。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Detect hardware</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  tpu = tf.distribute.cluster_resolver.TPUClusterResolver() <span class="comment"># TPU detection</span></span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">  tpu = <span class="literal">None</span></span><br><span class="line">  gpus = tf.config.experimental.list_logical_devices(<span class="string">&quot;GPU&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Select appropriate distribution strategy</span></span><br><span class="line"><span class="keyword">if</span> tpu:</span><br><span class="line">  tf.config.experimental_connect_to_cluster(tpu)</span><br><span class="line">  tf.tpu.experimental.initialize_tpu_system(tpu)</span><br><span class="line">  strategy = tf.distribute.experimental.TPUStrategy(tpu) <span class="comment"># Going back and forth between TPU and host is expensive. Better to run 128 batches on the TPU before reporting back.</span></span><br><span class="line">  print(<span class="string">&#x27;Running on TPU &#x27;</span>, tpu.cluster_spec().as_dict()[<span class="string">&#x27;worker&#x27;</span>])  </span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">len</span>(gpus) &gt; <span class="number">1</span>:</span><br><span class="line">  strategy = tf.distribute.MirroredStrategy([gpu.name <span class="keyword">for</span> gpu <span class="keyword">in</span> gpus])</span><br><span class="line">  print(<span class="string">&#x27;Running on multiple GPUs &#x27;</span>, [gpu.name <span class="keyword">for</span> gpu <span class="keyword">in</span> gpus])</span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">len</span>(gpus) == <span class="number">1</span>:</span><br><span class="line">  strategy = tf.distribute.get_strategy() <span class="comment"># default strategy that works on CPU and single GPU</span></span><br><span class="line">  print(<span class="string">&#x27;Running on single GPU &#x27;</span>, gpus[<span class="number">0</span>].name)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  strategy = tf.distribute.get_strategy() <span class="comment"># default strategy that works on CPU and single GPU</span></span><br><span class="line">  print(<span class="string">&#x27;Running on CPU&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;Number of accelerators: &quot;</span>, strategy.num_replicas_in_sync)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BATCH_SIZE = <span class="number">64</span> * strategy.num_replicas_in_sync <span class="comment"># Gobal batch size.</span></span><br><span class="line"><span class="comment"># The global batch size will be automatically sharded across all</span></span><br><span class="line"><span class="comment"># replicas by the tf.data.Dataset API. A single TPU has 8 cores.</span></span><br><span class="line"><span class="comment"># The best practice is to scale the batch size by the number of</span></span><br><span class="line"><span class="comment"># replicas (cores). The learning rate should be increased as well.</span></span><br></pre></td></tr></table></figure>

<h1 id="Loading-and-Preprocessing-the-Dataset"><a href="#Loading-and-Preprocessing-the-Dataset" class="headerlink" title="Loading and Preprocessing the Dataset"></a>Loading and Preprocessing the Dataset</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Transforms each image in dataset by pasting it on a 75x75 canvas at random locations.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_image_tfds</span>(<span class="params">image, label</span>):</span></span><br><span class="line">    xmin = tf.random.uniform((), <span class="number">0</span> , <span class="number">48</span>, dtype=tf.int32)</span><br><span class="line">    ymin = tf.random.uniform((), <span class="number">0</span> , <span class="number">48</span>, dtype=tf.int32)</span><br><span class="line">    image = tf.reshape(image, (<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>,))</span><br><span class="line">    image = tf.image.pad_to_bounding_box(image, ymin, xmin, <span class="number">75</span>, <span class="number">75</span>)</span><br><span class="line">    image = tf.cast(image, tf.float32)/<span class="number">255.0</span></span><br><span class="line">    xmin = tf.cast(xmin, tf.float32)</span><br><span class="line">    ymin = tf.cast(ymin, tf.float32)</span><br><span class="line">   </span><br><span class="line">    xmax = (xmin + <span class="number">28</span>) / <span class="number">75</span></span><br><span class="line">    ymax = (ymin + <span class="number">28</span>) / <span class="number">75</span></span><br><span class="line">    xmin = xmin / <span class="number">75</span></span><br><span class="line">    ymin = ymin / <span class="number">75</span></span><br><span class="line">    <span class="keyword">return</span> image, (tf.one_hot(label, <span class="number">10</span>), [xmin, ymin, xmax, ymax])</span><br><span class="line">  </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Loads and maps the training split of the dataset using the map function. Note that we try to load the gcs version since TPU can only work with datasets on Google Cloud Storage.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_training_dataset</span>():</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">with</span>  strategy.scope():</span><br><span class="line">        dataset = tfds.load(<span class="string">&quot;mnist&quot;</span>, split=<span class="string">&quot;train&quot;</span>, as_supervised=<span class="literal">True</span>, try_gcs=<span class="literal">True</span>)</span><br><span class="line">        dataset = dataset.<span class="built_in">map</span>(read_image_tfds, num_parallel_calls=<span class="number">16</span>)</span><br><span class="line">        dataset = dataset.shuffle(<span class="number">5000</span>, reshuffle_each_iteration=<span class="literal">True</span>)</span><br><span class="line">        dataset = dataset.repeat() <span class="comment"># Mandatory for Keras for now</span></span><br><span class="line">        dataset = dataset.batch(BATCH_SIZE, drop_remainder=<span class="literal">True</span>) <span class="comment"># drop_remainder is important on TPU, batch size must be fixed</span></span><br><span class="line">        dataset = dataset.prefetch(-<span class="number">1</span>)  <span class="comment"># fetch next batches while training on the current one (-1: autotune prefetch buffer size)</span></span><br><span class="line">      <span class="keyword">return</span> dataset</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Loads and maps the validation split of the dataset using the map function. Note that we try to load the gcs version since TPU can only work with datasets on Google Cloud Storage.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_validation_dataset</span>():</span></span><br><span class="line">    dataset = tfds.load(<span class="string">&quot;mnist&quot;</span>, split=<span class="string">&quot;test&quot;</span>, as_supervised=<span class="literal">True</span>, try_gcs=<span class="literal">True</span>)</span><br><span class="line">    dataset = dataset.<span class="built_in">map</span>(read_image_tfds, num_parallel_calls=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#dataset = dataset.cache() # this small dataset can be entirely cached in RAM</span></span><br><span class="line">    dataset = dataset.batch(<span class="number">10000</span>, drop_remainder=<span class="literal">True</span>) <span class="comment"># 10000 items in eval dataset, all in one batch</span></span><br><span class="line">    dataset = dataset.repeat() <span class="comment"># Mandatory for Keras for now</span></span><br><span class="line">    <span class="keyword">return</span> dataset</span><br><span class="line"></span><br><span class="line"><span class="comment"># instantiate the datasets</span></span><br><span class="line"><span class="keyword">with</span> strategy.scope():</span><br><span class="line">  training_dataset = get_training_dataset()</span><br><span class="line">  validation_dataset = get_validation_dataset()</span><br></pre></td></tr></table></figure>

<p>数据可视化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(training_digits, training_labels, training_bboxes,</span><br><span class="line"> validation_digits, validation_labels, validation_bboxes) = dataset_to_numpy_util(training_dataset, validation_dataset, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">display_digits_with_boxes(training_digits, training_labels, training_labels, np.array([]), training_bboxes, np.array([]), <span class="string">&quot;training digits and their labels&quot;</span>)</span><br><span class="line">display_digits_with_boxes(validation_digits, validation_labels, validation_labels, np.array([]), validation_bboxes, np.array([]), <span class="string">&quot;validation digits and their labels&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/14/cv-classification-localization/training_label.png"></p>
<p><img src="/2021/06/14/cv-classification-localization/validation_label.png"></p>
<h1 id="Define-the-Network"><a href="#Define-the-Network" class="headerlink" title="Define the Network"></a>Define the Network</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Feature extractor is the CNN that is made up of convolution and pooling layers.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feature_extractor</span>(<span class="params">inputs</span>):</span></span><br><span class="line">    x = tf.keras.layers.Conv2D(<span class="number">16</span>, activation=<span class="string">&#x27;relu&#x27;</span>, kernel_size=<span class="number">3</span>, input_shape=(<span class="number">75</span>, <span class="number">75</span>, <span class="number">1</span>))(inputs)</span><br><span class="line">    x = tf.keras.layers.AveragePooling2D((<span class="number">2</span>, <span class="number">2</span>))(x)</span><br><span class="line"></span><br><span class="line">    x = tf.keras.layers.Conv2D(<span class="number">32</span>,kernel_size=<span class="number">3</span>,activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    x = tf.keras.layers.AveragePooling2D((<span class="number">2</span>, <span class="number">2</span>))(x)</span><br><span class="line"></span><br><span class="line">    x = tf.keras.layers.Conv2D(<span class="number">64</span>,kernel_size=<span class="number">3</span>,activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    x = tf.keras.layers.AveragePooling2D((<span class="number">2</span>, <span class="number">2</span>))(x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dense_layers adds a flatten and dense layer.</span></span><br><span class="line"><span class="string">This will follow the feature extraction layers</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dense_layers</span>(<span class="params">inputs</span>):</span></span><br><span class="line">  x = tf.keras.layers.Flatten()(inputs)</span><br><span class="line">  x = tf.keras.layers.Dense(<span class="number">128</span>, activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">  <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Classifier defines the classification output.</span></span><br><span class="line"><span class="string">This has a set of fully connected layers and a softmax layer.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classifier</span>(<span class="params">inputs</span>):</span></span><br><span class="line"></span><br><span class="line">  classification_output = tf.keras.layers.Dense(<span class="number">10</span>, activation=<span class="string">&#x27;softmax&#x27;</span>, name = <span class="string">&#x27;classification&#x27;</span>)(inputs)</span><br><span class="line">  <span class="keyword">return</span> classification_output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">This function defines the regression output for bounding box prediction. </span></span><br><span class="line"><span class="string">Note that we have four outputs corresponding to (xmin, ymin, xmax, ymax)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bounding_box_regression</span>(<span class="params">inputs</span>):</span></span><br><span class="line">    bounding_box_regression_output = tf.keras.layers.Dense(units = <span class="string">&#x27;4&#x27;</span>, name = <span class="string">&#x27;bounding_box&#x27;</span>)(inputs)</span><br><span class="line">    <span class="keyword">return</span> bounding_box_regression_output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">final_model</span>(<span class="params">inputs</span>):</span></span><br><span class="line">    feature_cnn = feature_extractor(inputs)</span><br><span class="line">    dense_output = dense_layers(feature_cnn)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    The model branches here.  </span></span><br><span class="line"><span class="string">    The dense layer&#x27;s output gets fed into two branches:</span></span><br><span class="line"><span class="string">    classification_output and bounding_box_output</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    classification_output = classifier(dense_output)</span><br><span class="line">    bounding_box_output = bounding_box_regression(dense_output)</span><br><span class="line"></span><br><span class="line">    model = tf.keras.Model(inputs = inputs, outputs = [classification_output, bounding_box_output])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">define_and_compile_model</span>(<span class="params">inputs</span>):</span></span><br><span class="line">  model = final_model(inputs)</span><br><span class="line">  </span><br><span class="line">  model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, </span><br><span class="line">              loss = &#123;<span class="string">&#x27;classification&#x27;</span> : <span class="string">&#x27;categorical_crossentropy&#x27;</span>,</span><br><span class="line">                      <span class="string">&#x27;bounding_box&#x27;</span> : <span class="string">&#x27;mse&#x27;</span></span><br><span class="line">                     &#125;,</span><br><span class="line">              metrics = &#123;<span class="string">&#x27;classification&#x27;</span> : <span class="string">&#x27;accuracy&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;bounding_box&#x27;</span> : <span class="string">&#x27;mse&#x27;</span></span><br><span class="line">                        &#125;)</span><br><span class="line">  <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> strategy.scope():</span><br><span class="line">  inputs = tf.keras.layers.Input(shape=(<span class="number">75</span>, <span class="number">75</span>, <span class="number">1</span>,))</span><br><span class="line">  model = define_and_compile_model(inputs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print model layers</span></span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Model: &quot;model&quot;</span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">Layer (type)                    Output Shape         Param #     Connected to                     </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">input_1 (InputLayer)            [(None, 75, 75, 1)]  0                                            </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d (Conv2D)                 (None, 73, 73, 16)   160         input_1[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">average_pooling2d (AveragePooli (None, 36, 36, 16)   0           conv2d[0][0]                     </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_1 (Conv2D)               (None, 34, 34, 32)   4640        average_pooling2d[0][0]          </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">average_pooling2d_1 (AveragePoo (None, 17, 17, 32)   0           conv2d_1[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">conv2d_2 (Conv2D)               (None, 15, 15, 64)   18496       average_pooling2d_1[0][0]        </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">average_pooling2d_2 (AveragePoo (None, 7, 7, 64)     0           conv2d_2[0][0]                   </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">flatten (Flatten)               (None, 3136)         0           average_pooling2d_2[0][0]        </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">dense (Dense)                   (None, 128)          401536      flatten[0][0]                    </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">classification (Dense)          (None, 10)           1290        dense[0][0]                      </span><br><span class="line">__________________________________________________________________________________________________</span><br><span class="line">bounding_box (Dense)            (None, 4)            516         dense[0][0]                      </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Total params: 426,638</span><br><span class="line">Trainable params: 426,638</span><br><span class="line">Non-trainable params: 0</span><br></pre></td></tr></table></figure>

<h1 id="Train-and-validate-the-model"><a href="#Train-and-validate-the-model" class="headerlink" title="Train and validate the model"></a>Train and validate the model</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EPOCHS = <span class="number">10</span> <span class="comment"># 45</span></span><br><span class="line">steps_per_epoch = <span class="number">60000</span>//BATCH_SIZE  <span class="comment"># 60,000 items in this dataset</span></span><br><span class="line">validation_steps = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">history = model.fit(training_dataset,</span><br><span class="line">                    steps_per_epoch=steps_per_epoch, validation_data=validation_dataset, validation_steps=validation_steps, epochs=EPOCHS)</span><br><span class="line"></span><br><span class="line">loss, classification_loss, bounding_box_loss, classification_accuracy, bounding_box_mse = model.evaluate(validation_dataset, steps=<span class="number">1</span>)</span><br><span class="line">print(<span class="string">&quot;Validation accuracy: &quot;</span>, classification_accuracy)</span><br></pre></td></tr></table></figure>

<p>Epoch 1/10<br>117/117 [==============================] - 8s 34ms/step - loss: 2.1438 - classification_loss: 2.1235 - bounding_box_loss: 0.0203 - classification_accuracy: 0.2177 - bounding_box_mse: 0.0203 - val_loss: 1.6952 - val_classification_loss: 1.6842 - val_bounding_box_loss: 0.0110 - val_classification_accuracy: 0.3951 - val_bounding_box_mse: 0.0110<br>Epoch 2/10<br>117/117 [==============================] - 3s 24ms/step - loss: 1.1399 - classification_loss: 1.1215 - bounding_box_loss: 0.0184 - classification_accuracy: 0.6351 - bounding_box_mse: 0.0184 - val_loss: 0.5869 - val_classification_loss: 0.5663 - val_bounding_box_loss: 0.0207 - val_classification_accuracy: 0.8352 - val_bounding_box_mse: 0.0207<br>Epoch 3/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.4874 - classification_loss: 0.4683 - bounding_box_loss: 0.0192 - classification_accuracy: 0.8628 - bounding_box_mse: 0.0192 - val_loss: 0.3779 - val_classification_loss: 0.3638 - val_bounding_box_loss: 0.0141 - val_classification_accuracy: 0.8944 - val_bounding_box_mse: 0.0141<br>Epoch 4/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.3494 - classification_loss: 0.3360 - bounding_box_loss: 0.0134 - classification_accuracy: 0.9008 - bounding_box_mse: 0.0134 - val_loss: 0.2990 - val_classification_loss: 0.2875 - val_bounding_box_loss: 0.0116 - val_classification_accuracy: 0.9132 - val_bounding_box_mse: 0.0116<br>Epoch 5/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.2930 - classification_loss: 0.2806 - bounding_box_loss: 0.0124 - classification_accuracy: 0.9165 - bounding_box_mse: 0.0124 - val_loss: 0.2370 - val_classification_loss: 0.2270 - val_bounding_box_loss: 0.0099 - val_classification_accuracy: 0.9339 - val_bounding_box_mse: 0.0099<br>Epoch 6/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.2551 - classification_loss: 0.2444 - bounding_box_loss: 0.0107 - classification_accuracy: 0.9276 - bounding_box_mse: 0.0107 - val_loss: 0.2047 - val_classification_loss: 0.1963 - val_bounding_box_loss: 0.0084 - val_classification_accuracy: 0.9417 - val_bounding_box_mse: 0.0084<br>Epoch 7/10<br>117/117 [==============================] - 3s 26ms/step - loss: 0.2298 - classification_loss: 0.2209 - bounding_box_loss: 0.0088 - classification_accuracy: 0.9350 - bounding_box_mse: 0.0088 - val_loss: 0.1943 - val_classification_loss: 0.1866 - val_bounding_box_loss: 0.0077 - val_classification_accuracy: 0.9430 - val_bounding_box_mse: 0.0077<br>Epoch 8/10<br>117/117 [==============================] - 3s 24ms/step - loss: 0.2106 - classification_loss: 0.2025 - bounding_box_loss: 0.0082 - classification_accuracy: 0.9394 - bounding_box_mse: 0.0082 - val_loss: 0.1777 - val_classification_loss: 0.1706 - val_bounding_box_loss: 0.0072 - val_classification_accuracy: 0.9491 - val_bounding_box_mse: 0.0072<br>Epoch 9/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.1939 - classification_loss: 0.1868 - bounding_box_loss: 0.0071 - classification_accuracy: 0.9446 - bounding_box_mse: 0.0071 - val_loss: 0.1674 - val_classification_loss: 0.1614 - val_bounding_box_loss: 0.0060 - val_classification_accuracy: 0.9532 - val_bounding_box_mse: 0.0060<br>Epoch 10/10<br>117/117 [==============================] - 3s 25ms/step - loss: 0.1820 - classification_loss: 0.1757 - bounding_box_loss: 0.0063 - classification_accuracy: 0.9477 - bounding_box_mse: 0.0063 - val_loss: 0.1490 - val_classification_loss: 0.1431 - val_bounding_box_loss: 0.0060 - val_classification_accuracy: 0.9569 - val_bounding_box_mse: 0.0060<br>1/1 [==============================] - 1s 846ms/step - loss: 0.1548 - classification_loss: 0.1489 - bounding_box_loss: 0.0060 - classification_accuracy: 0.9542 - bounding_box_mse: 0.0060<br>Validation accuracy:  0.9541999697685242</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot_metrics(<span class="string">&quot;classification_loss&quot;</span>, <span class="string">&quot;Classification Loss&quot;</span>)</span><br><span class="line">plot_metrics(<span class="string">&quot;bounding_box_loss&quot;</span>, <span class="string">&quot;Bounding Box Loss&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/14/cv-classification-localization/classification_box_loss.png"></p>
<h1 id="Intersection-over-union"><a href="#Intersection-over-union" class="headerlink" title="Intersection over union"></a>Intersection over union</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intersection_over_union</span>(<span class="params">pred_box, true_box</span>):</span></span><br><span class="line">    xmin_pred, ymin_pred, xmax_pred, ymax_pred =  np.split(pred_box, <span class="number">4</span>, axis = <span class="number">1</span>)</span><br><span class="line">    xmin_true, ymin_true, xmax_true, ymax_true = np.split(true_box, <span class="number">4</span>, axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    smoothing_factor = <span class="number">1e-10</span></span><br><span class="line"></span><br><span class="line">    xmin_overlap = np.maximum(xmin_pred, xmin_true)</span><br><span class="line">    xmax_overlap = np.minimum(xmax_pred, xmax_true)</span><br><span class="line">    ymin_overlap = np.maximum(ymin_pred, ymin_true)</span><br><span class="line">    ymax_overlap = np.minimum(ymax_pred, ymax_true)</span><br><span class="line"></span><br><span class="line">    pred_box_area = (xmax_pred - xmin_pred) * (ymax_pred - ymin_pred)</span><br><span class="line">    true_box_area = (xmax_true - xmin_true) * (ymax_true - ymin_true)</span><br><span class="line"></span><br><span class="line">    overlap_area = np.maximum((xmax_overlap - xmin_overlap), <span class="number">0</span>)  * np.maximum((ymax_overlap - ymin_overlap), <span class="number">0</span>)</span><br><span class="line">    union_area = (pred_box_area + true_box_area) - overlap_area</span><br><span class="line">    </span><br><span class="line">    iou = (overlap_area + smoothing_factor) / (union_area + smoothing_factor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iou</span><br></pre></td></tr></table></figure>

<h1 id="Visualize-predictions"><a href="#Visualize-predictions" class="headerlink" title="Visualize predictions"></a>Visualize predictions</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># recognize validation digits</span></span><br><span class="line">predictions = model.predict(validation_digits, batch_size=<span class="number">64</span>)</span><br><span class="line">predicted_labels = np.argmax(predictions[<span class="number">0</span>], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">predicted_bboxes = predictions[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">iou = intersection_over_union(predicted_bboxes, validation_bboxes)</span><br><span class="line"></span><br><span class="line">iou_threshold = <span class="number">0.6</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Number of predictions where iou &gt; threshold(%s): %s&quot;</span> % (iou_threshold, (iou &gt;= iou_threshold).<span class="built_in">sum</span>()))</span><br><span class="line">print(<span class="string">&quot;Number of predictions where iou &lt; threshold(%s): %s&quot;</span> % (iou_threshold, (iou &lt; iou_threshold).<span class="built_in">sum</span>()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">display_digits_with_boxes(validation_digits, predicted_labels, validation_labels, predicted_bboxes, validation_bboxes, iou, <span class="string">&quot;True and Predicted values&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/visualize_prediction.png"></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Young Times
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2021/06/14/cv-classification-localization/" title="Image Classification and Object Localization">http://example.com/2021/06/14/cv-classification-localization/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/" rel="tag"># 自动驾驶</a>
              <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag"># 机器学习</a>
              <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"># 深度学习</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/14/object_detection/" rel="prev" title="Object Detection">
      <i class="fa fa-chevron-left"></i> Object Detection
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Imports"><span class="nav-number">1.</span> <span class="nav-text">Imports</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Visualization-Utilities"><span class="nav-number">2.</span> <span class="nav-text">Visualization Utilities</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TPU-or-GPU-detection"><span class="nav-number">3.</span> <span class="nav-text">TPU or GPU detection</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Loading-and-Preprocessing-the-Dataset"><span class="nav-number">4.</span> <span class="nav-text">Loading and Preprocessing the Dataset</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Define-the-Network"><span class="nav-number">5.</span> <span class="nav-text">Define the Network</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Train-and-validate-the-model"><span class="nav-number">6.</span> <span class="nav-text">Train and validate the model</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Intersection-over-union"><span class="nav-number">7.</span> <span class="nav-text">Intersection over union</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Visualize-predictions"><span class="nav-number">8.</span> <span class="nav-text">Visualize predictions</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Young Times"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">Young Times</p>
  <div class="site-description" itemprop="description">路要一步一步的走</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Young Times</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">195k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:57</span>
</div>

<span id="busuanzi_container_site_uv">
  本站访问次数：<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
</span>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'hEvBR6pmxtoYkRhC3fnMB8Yq-gzGzoHsz',
      appKey     : 'nIkzvtLYb1avq32c9GYfgOOW',
      placeholder: "Please Leave Your Message Here...",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
